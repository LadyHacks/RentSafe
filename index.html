<html>
	<head>
		<title>- Rent Safe -</title>

		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
		<link rel="stylesheet" href="css/foundation.css">
		<link href='http://fonts.googleapis.com/css?family=Dancing+Script:400,700' rel='stylesheet' type='text/css'>

		<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

		<script src="esri-leaflet-src.js"></script>
		<script src="esri-leaflet-master/dist/extras/heatmap-feature-layer-src.js"></script>
		<script src="esri-leaflet-master/examples/lib/leaflet-heat/leaflet-heat.js"></script>

		<style>
			#map { height: 70%; }
		</style>
	</head>
	<body>
		<div class = "panel">
		<h1> Rent Safe</h1>
	</div>
		<div class = "large-11 large-centered columns">
			<div id="map"></div>
		</div>

		<script>

			var map = L.map('map').setView([39.9522, -75.1639], 15);

			L.esri.basemapLayer("Topographic").addTo(map);

			L.esri.heatMapFeatureLayer("http://gis.phila.gov/ArcGIS/rest/services/PhilaGov/Police_Incidents_Last30/MapServer/0/query?geometry={%22rings%22:[[[-75.392990,39.846504],%20[-74.912338,39.846504],%20[-74.912338,40.161559],%20[-75.392990,40.161559]]],%22spatialReference%22:{%22wkid%22:4326}}&geometryType=esriGeometryPolygon&spatialRel=esriSpatialRelContains&outFields=*&inSR=4326&outSR=4326&f=pjson&pretty=true", {
				 radius: 20,
				  gradient: {
				    0.4: "#ff0000",
				    0.65: "#330066",
				    1: "#000000"
				  }

	      	}).addTo(map);

	      	var minDate = Math.round((new Date().getTime()/1000)-(60*24*60*60));
			function getPage (page){
				var url = "http://search.3taps.com/?auth_token=e89e3fd24f2e7dae86975eca23704e87&location.city=USA-PHI-PHI&category_group=RRRR&rpp=100&retvals=location,external_url,price,heading,timestamp&timestamp="+minDate+"..";
				if (page!==undefined) {
					url+="&page="+page
				}
				$.getJSON(url, 
					function (data) {
						// console.log(data)
						for (var i=0; i<data.postings.length; i++) {
							var lat = data.postings[i].location["lat"]
							var lng = data.postings[i].location["long"]
							var heading = data.postings[i].heading
							var price = data.postings[i].price
							var externalURL = data.postings[i].external_url
							var timeStamp = parseInt(data.postings[i].timestamp) * 1000
							var dt = new Date(timeStamp)


							var marker = L.marker([lat, lng]).addTo(map);
							marker.bindPopup("<h4>" + heading + "</h4><h5> Price: $" + price + "</h5><a href = " + externalURL + "><h6>" + externalURL + "</h6></a>");
						}
						var nextPage = data.next_page
						if (nextPage !==-1 && nextPage<10){
							getPage(nextPage)
						}
					})
			}
			getPage();

	      	
		</script>
	</body>
</html>